#!/usr/bin/env node

/**
 * üåê Generador CDN H√≠brido v3.9.0 - Sistema Actualizado
 * Crea estructura completa para CDN personal robusto
 */

const https = require('https');
const fs = require('fs');
const path = require('path');

console.log('üåê Generador CDN H√≠brido v3.9.0 - Sistema Actualizado\n');

// Lista actualizada de bibliotecas esenciales para CDN personal
const BIBLIOTECAS_ESENCIALES = [
    // CR√çTICAS (siempre fallan)
    {
        nombre: 'Owl Carousel JS',
        url: 'https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js',
        destino: 'cdn-hibrido/owl-carousel/owl.carousel.min.js',
        prioridad: 'üö® CR√çTICO',
        razon: 'Falla constantemente en CDNs oficiales'
    },
    {
        nombre: 'Owl Carousel CSS',
        url: 'https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css',
        destino: 'cdn-hibrido/owl-carousel/owl.carousel.min.css',
        prioridad: 'üö® CR√çTICO',
        razon: 'Falla constantemente en CDNs oficiales'
    },
    
    // POPULARES (respaldo para cuando fallen)
    {
        nombre: 'Bootstrap CSS',
        url: 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css',
        destino: 'cdn-hibrido/bootstrap/bootstrap.min.css',
        prioridad: 'üì¶ POPULAR',
        razon: 'Respaldo para versiones espec√≠ficas'
    },
    {
        nombre: 'Bootstrap JS',
        url: 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js',
        destino: 'cdn-hibrido/bootstrap/bootstrap.min.js',
        prioridad: 'üì¶ POPULAR',
        razon: 'Respaldo para versiones espec√≠ficas'
    },
    {
        nombre: 'jQuery',
        url: 'https://code.jquery.com/jquery-3.7.1.min.js',
        destino: 'cdn-hibrido/jquery/jquery.min.js',
        prioridad: 'üì¶ POPULAR',
        razon: 'Base de muchas bibliotecas'
    },
    {
        nombre: 'Font Awesome',
        url: 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css',
        destino: 'cdn-hibrido/font-awesome/all.min.css',
        prioridad: 'üé® ICONOS',
        razon: 'Versi√≥n gratuita actualizada'
    },
    {
        nombre: 'Animate CSS',
        url: 'https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css',
        destino: 'cdn-hibrido/animate/animate.min.css',
        prioridad: '‚ú® ANIMACI√ìN',
        razon: 'Efectos populares'
    },
    {
        nombre: 'AOS CSS',
        url: 'https://unpkg.com/aos@2.3.1/dist/aos.css',
        destino: 'cdn-hibrido/aos/aos.css',
        prioridad: 'üé≠ SCROLL',
        razon: 'Animaciones en scroll'
    },
    {
        nombre: 'AOS JS',
        url: 'https://unpkg.com/aos@2.3.1/dist/aos.js',
        destino: 'cdn-hibrido/aos/aos.js',
        prioridad: 'üé≠ SCROLL',
        razon: 'Animaciones en scroll'
    },
    {
        nombre: 'Swiper CSS',
        url: 'https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css',
        destino: 'cdn-hibrido/swiper/swiper-bundle.min.css',
        prioridad: 'üì± M√ìVIL',
        razon: 'Sliders modernos'
    },
    {
        nombre: 'Swiper JS',
        url: 'https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js',
        destino: 'cdn-hibrido/swiper/swiper-bundle.min.js',
        prioridad: 'üì± M√ìVIL',
        razon: 'Sliders modernos'
    },
    {
        nombre: 'Lightbox2 CSS',
        url: 'https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/css/lightbox.min.css',
        destino: 'cdn-hibrido/lightbox2/lightbox.min.css',
        prioridad: 'üñºÔ∏è GALER√çA',
        razon: 'Galer√≠as de im√°genes'
    },
    {
        nombre: 'Lightbox2 JS',
        url: 'https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox.min.js',
        destino: 'cdn-hibrido/lightbox2/lightbox.min.js',
        prioridad: 'üñºÔ∏è GALER√çA',
        razon: 'Galer√≠as de im√°genes'
    },
    {
        nombre: 'Isotope',
        url: 'https://unpkg.com/isotope-layout@3.0.6/dist/isotope.pkgd.min.js',
        destino: 'cdn-hibrido/isotope/isotope.pkgd.min.js',
        prioridad: 'üß© LAYOUT',
        razon: 'Grids filtrados'
    },
    {
        nombre: 'WOW.js',
        url: 'https://cdnjs.cloudflare.com/ajax/libs/wow/1.1.2/wow.min.js',
        destino: 'cdn-hibrido/wow/wow.min.js',
        prioridad: 'üí´ REVEAL',
        razon: 'Animaciones reveal'
    },
    {
        nombre: 'Slick CSS',
        url: 'https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.css',
        destino: 'cdn-hibrido/slick/slick.css',
        prioridad: 'üé† CAROUSEL',
        razon: 'Carousels alternativos'
    },
    {
        nombre: 'Slick JS',
        url: 'https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.js',
        destino: 'cdn-hibrido/slick/slick.min.js',
        prioridad: 'üé† CAROUSEL',
        razon: 'Carousels alternativos'
    }
];

// Archivos especiales que requieren configuraci√≥n manual
const ARCHIVOS_ESPECIALES = [
    {
        nombre: 'Font Awesome Pro',
        destino: 'cdn-hibrido/font-awesome-pro/css/all.min.css',
        prioridad: 'üíé PRO',
        instruccion: 'Subir tu archivo de Font Awesome Pro aqu√≠',
        contenido: `/* Font Awesome Pro CSS - Archivo Manual
 * 
 * INSTRUCCIONES:
 * 1. Descarga tu archivo all.min.css de Font Awesome Pro
 * 2. Reemplaza este archivo con tu versi√≥n Pro
 * 3. Mant√©n la estructura de carpetas
 * 
 * URL Final: https://cdn.susitio.cl/libs/font-awesome-pro/css/all.min.css
 */

/* Placeholder - Reemplazar con archivo Pro real */`
    },
    {
        nombre: 'YTPlayer JS',
        destino: 'cdn-hibrido/ytplayer/jquery.mb.YTPlayer.min.js',
        prioridad: 'üì∫ VIDEO',
        instruccion: 'Se descarga desde GitHub oficial autom√°ticamente',
        url: 'https://raw.githubusercontent.com/pupunzi/jquery.mb.YTPlayer/master/src/jquery.mb.YTPlayer.src.js'
    },
    {
        nombre: 'YTPlayer CSS',
        destino: 'cdn-hibrido/ytplayer/jquery.mb.YTPlayer.min.css',
        prioridad: 'üì∫ VIDEO', 
        instruccion: 'Se descarga desde GitHub oficial autom√°ticamente',
        url: 'https://raw.githubusercontent.com/pupunzi/jquery.mb.YTPlayer/master/src/css/jquery.mb.YTPlayer.min.css'
    }
];

/**
 * Crear directorios necesarios
 */
function crearEstructura() {
    const directorios = [
        'cdn-hibrido/fallback/css',
        'cdn-hibrido/fallback/js',
        'cdn-hibrido/owl-carousel',
        'cdn-hibrido/font-awesome',
        'cdn-hibrido/font-awesome-pro/css',
        'cdn-hibrido/bootstrap',
        'cdn-hibrido/jquery',
        'cdn-hibrido/animate',
        'cdn-hibrido/aos',
        'cdn-hibrido/swiper',
        'cdn-hibrido/lightbox2',
        'cdn-hibrido/isotope',
        'cdn-hibrido/wow',
        'cdn-hibrido/slick',
        'cdn-hibrido/ytplayer'
    ];
    
    directorios.forEach(dir => {
        if (!fs.existsSync(dir)) {
            fs.mkdirSync(dir, { recursive: true });
            console.log(`üìÅ ${dir}`);
        }
    });
}

/**
 * Descargar archivo con manejo de errores mejorado
 */
function descargarArchivo(url, destino, nombre) {
    return new Promise((resolve, reject) => {
        console.log(`üì• ${nombre}...`);
        
        const archivo = fs.createWriteStream(destino);
        const modulo = url.startsWith('https:') ? https : require('http');
        
        const request = modulo.get(url, (response) => {
            if (response.statusCode === 200) {
                response.pipe(archivo);
                
                archivo.on('finish', () => {
                    archivo.close();
                    const stats = fs.statSync(destino);
                    const tama√±o = (stats.size / 1024).toFixed(1);
                    console.log(`   ‚úÖ ${tama√±o} KB`);
                    resolve(true);
                });
            } else if (response.statusCode === 301 || response.statusCode === 302) {
                // Manejar redirecciones
                const nuevaUrl = response.headers.location;
                console.log(`   üîÑ Redirigiendo...`);
                descargarArchivo(nuevaUrl, destino, nombre).then(resolve).catch(reject);
            } else {
                console.log(`   ‚ùå HTTP ${response.statusCode}`);
                reject(new Error(`HTTP ${response.statusCode}`));
            }
        });
        
        request.on('error', (error) => {
            console.log(`   ‚ùå ${error.message}`);
            reject(error);
        });
        
        request.setTimeout(15000, () => {
            request.destroy();
            console.log(`   ‚ùå Timeout`);
            reject(new Error('Timeout'));
        });
    });
}

/**
 * Generar CDN h√≠brido completo
 */
async function generarCDNHibrido() {
    console.log('üéØ Generando CDN H√≠brido v3.9.0 con bibliotecas actualizadas...\n');
    
    // Crear estructura
    console.log('üìÅ Creando estructura de directorios...\n');
    crearEstructura();
    
    let exitosos = 0;
    let fallidos = 0;
    
    // Descargar bibliotecas autom√°ticas
    console.log('\nüì¶ DESCARGANDO BIBLIOTECAS ESENCIALES:\n');
    
    for (const lib of BIBLIOTECAS_ESENCIALES) {
        try {
            const dir = path.dirname(lib.destino);
            if (!fs.existsSync(dir)) {
                fs.mkdirSync(dir, { recursive: true });
            }
            
            await descargarArchivo(lib.url, lib.destino, lib.nombre);
            console.log(`   ${lib.prioridad} - ${lib.razon}\n`);
            exitosos++;
        } catch (error) {
            console.log(`   ‚ùå FALL√ì: ${error.message}\n`);
            fallidos++;
        }
    }
    
    // Crear archivos especiales
    console.log('üîπ CONFIGURANDO ARCHIVOS ESPECIALES:\n');
    
    for (const especial of ARCHIVOS_ESPECIALES) {
        const dir = path.dirname(especial.destino);
        if (!fs.existsSync(dir)) {
            fs.mkdirSync(dir, { recursive: true });
        }
        
        if (especial.url) {
            // Descargar desde URL
            try {
                await descargarArchivo(especial.url, especial.destino, especial.nombre);
                console.log(`   ${especial.prioridad} - ${especial.instruccion}\n`);
            } catch (error) {
                console.log(`   ‚ùå ${especial.nombre}: ${error.message}\n`);
            }
        } else {
            // Crear placeholder
            fs.writeFileSync(especial.destino, especial.contenido || '/* Placeholder */');
            console.log(`üìù ${especial.nombre}`);
            console.log(`   ${especial.prioridad} - ${especial.instruccion}\n`);
        }
    }
    
    // Crear estructura fallback
    console.log('üÜò Creando estructura fallback...\n');
    
    const fallbackReadme = `# üÜò Fallback Directory

Esta carpeta es para archivos especiales que no est√°n en las bibliotecas est√°ndar.

## Estructura:
- css/: Archivos CSS personalizados
- js/: Archivos JavaScript personalizados

## URL de acceso:
https://cdn.susitio.cl/libs/fallback/css/archivo-personalizado.css
https://cdn.susitio.cl/libs/fallback/js/archivo-personalizado.js

## Uso:
Cuando ZiteBackJS v3.9.0 no encuentra un archivo en bibliotecas conocidas,
intentar√° buscarlo aqu√≠ usando la estructura:
/fallback/[tipo]/[nombre-archivo]
`;
    
    fs.writeFileSync('cdn-hibrido/fallback/README.md', fallbackReadme);
    
    // Generar documentaci√≥n final
    const docFinal = `# üåê CDN H√≠brido v3.9.0 - Configuraci√≥n Completa

## üìä Resumen de Generaci√≥n

- ‚úÖ **Bibliotecas descargadas**: ${exitosos}
- ‚ùå **Fallos**: ${fallidos}
- üìÅ **Estructura creada**: Completa
- üÜò **Fallback configurado**: S√≠

## üöÄ Subir a Servidor

### 1. Subir toda la carpeta \`cdn-hibrido\` a:
\`\`\`
https://cdn.susitio.cl/libs/
\`\`\`

### 2. Resultado final:
\`\`\`
https://cdn.susitio.cl/libs/owl-carousel/owl.carousel.min.js    ‚Üê CR√çTICO
https://cdn.susitio.cl/libs/bootstrap/bootstrap.min.css        ‚Üê POPULAR  
https://cdn.susitio.cl/libs/font-awesome/all.min.css           ‚Üê ICONOS
https://cdn.susitio.cl/libs/jquery/jquery.min.js               ‚Üê BASE
...y todas las dem√°s bibliotecas
\`\`\`

### 3. Verificar funcionamiento:
\`\`\`bash
curl -I https://cdn.susitio.cl/libs/owl-carousel/owl.carousel.min.js
curl -I https://cdn.susitio.cl/libs/bootstrap/bootstrap.min.css
\`\`\`

## üîß Configuraci√≥n Manual Pendiente

${ARCHIVOS_ESPECIALES.filter(a => a.contenido).map(a => 
`### ${a.nombre}
- **Archivo**: \`${a.destino}\`
- **Acci√≥n**: ${a.instruccion}`).join('\n\n')}

## üìà Cobertura de Bibliotecas

**CR√çTICAS**: Owl Carousel (siempre falla)
**POPULARES**: Bootstrap, jQuery, Font Awesome
**ANIMACIONES**: Animate.css, AOS, WOW
**SLIDERS**: Swiper, Slick
**GALER√çAS**: Lightbox2
**LAYOUTS**: Isotope, Masonry

## üéØ Pr√≥ximos Pasos

1. ‚úÖ Subir contenido a servidor
2. üíé Configurar Font Awesome Pro (si aplica)
3. üß™ Probar con ZiteBackJS v3.9.0
4. üìä Monitorear logs de fallos
5. üîÑ Actualizar bibliotecas seg√∫n necesidad

---

**CDN H√≠brido v3.9.0** listo para m√°xima confiabilidad üåê‚ú®
`;
    
    fs.writeFileSync('cdn-hibrido/CONFIGURACION.md', docFinal);
    
    // Resumen final
    console.log('üìä RESUMEN FINAL:\n');
    console.log(`‚úÖ Bibliotecas descargadas: ${exitosos}`);
    console.log(`‚ùå Fallos: ${fallidos}`);
    console.log(`üìÅ Estructura: Completa`);
    console.log(`üÜò Fallback: Configurado`);
    
    console.log('\nüéØ PR√ìXIMOS PASOS:\n');
    console.log('1. üìÅ Revisar carpeta "cdn-hibrido"');
    console.log('2. üíé Configurar Font Awesome Pro (si aplica)');
    console.log('3. üöÄ Subir todo a https://cdn.susitio.cl/libs/');
    console.log('4. üß™ Probar con ZiteBackJS v3.9.0');
    console.log('5. üìä Monitorear logs para futuras actualizaciones');
    
    console.log('\nüìÑ Ver "cdn-hibrido/CONFIGURACION.md" para detalles completos');
    
    if (exitosos >= BIBLIOTECAS_ESENCIALES.length * 0.8) {
        console.log('\nüéâ ¬°CDN H√≠brido v3.9.0 generado exitosamente!');
        console.log('üåê Sistema robusto listo para m√°xima confiabilidad');
    } else {
        console.log('\n‚ö†Ô∏è Algunos archivos fallaron. Verifica conexi√≥n y reintenta.');
    }
}

// Ejecutar
console.log('‚ÑπÔ∏è CDN H√≠brido v3.9.0: Sistema actualizado con 15+ bibliotecas populares');
console.log('‚ÑπÔ∏è Detecci√≥n avanzada de errores y respaldos robustos\n');

generarCDNHibrido().catch(console.error);